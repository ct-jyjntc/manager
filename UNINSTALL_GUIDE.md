# 卸载指南

## 📋 概述

为了提供完整的生命周期管理，我们为进程保活管理器创建了两个卸载脚本，满足不同的卸载需求。

## 🗑️ 卸载选项

### 1. 完全卸载 (`uninstall-debian.sh`)

**适用场景：**
- 完全移除系统中的所有相关组件
- 服务器重新部署或用途变更
- 彻底清理系统环境

**删除内容：**
- ✅ systemd 服务配置
- ✅ PM2 进程和配置
- ✅ 应用程序文件和目录
- ✅ 配置和数据文件
- ✅ 日志文件
- ✅ 防火墙规则
- ✅ 临时文件和缓存
- 🔧 可选：Node.js 和 npm
- 🔧 可选：PM2 全局安装
- 🔧 可选：SSH 密钥（备份后删除）

**使用方法：**
```bash
chmod +x uninstall-debian.sh
sudo ./uninstall-debian.sh
```

### 2. 快速卸载 (`quick-uninstall.sh`)

**适用场景：**
- 只移除应用程序，保留系统环境
- 准备重新安装或升级
- 保持开发环境完整

**删除内容：**
- ✅ 应用程序文件
- ✅ 配置数据文件
- ✅ 服务配置
- ✅ 日志文件
- ✅ 防火墙规则

**保留内容：**
- 🔒 Node.js 和 npm
- 🔒 PM2 全局安装
- 🔒 SSH 配置和密钥
- 🔒 系统依赖包

**使用方法：**
```bash
chmod +x quick-uninstall.sh
sudo ./quick-uninstall.sh
```

## 🔧 详细功能对比

| 功能 | 完全卸载 | 快速卸载 |
|------|----------|----------|
| 停止服务 | ✅ | ✅ |
| 删除应用文件 | ✅ | ✅ |
| 删除配置数据 | ✅ | ✅ |
| 删除日志文件 | ✅ | ✅ |
| 清理防火墙 | ✅ | ✅ |
| 删除 Node.js | 🔧 可选 | ❌ |
| 删除 PM2 | 🔧 可选 | ❌ |
| 删除 SSH 密钥 | 🔧 可选 | ❌ |
| 生成报告 | ✅ | ❌ |
| 交互式确认 | ✅ | ✅ |

## 🛡️ 安全特性

### 数据保护
- **确认提示**: 所有危险操作都需要用户确认
- **备份机制**: SSH 密钥删除前自动备份
- **分步执行**: 逐步执行，出错时可以中断
- **详细日志**: 记录所有操作步骤

### 权限检查
- **Root 权限验证**: 确保有足够权限执行系统级操作
- **文件权限检查**: 验证文件存在性和权限
- **服务状态检查**: 安全停止运行中的服务

## 📊 卸载流程

### 完全卸载流程
```
1. 权限检查 → 2. 用户确认 → 3. 停止服务
     ↓
4. 删除应用 → 5. 清理配置 → 6. 清理日志
     ↓
7. 清理防火墙 → 8. 可选清理 → 9. 验证结果
     ↓
10. 生成报告 → 11. 完成
```

### 快速卸载流程
```
1. 权限检查 → 2. 用户确认 → 3. 停止服务
     ↓
4. 删除应用 → 5. 清理配置 → 6. 清理日志
     ↓
7. 清理防火墙 → 8. 完成
```

## 🔍 卸载验证

### 自动验证项目
- **服务状态**: 检查 systemd 服务是否完全删除
- **进程检查**: 确认没有相关进程在运行
- **端口检查**: 验证端口 3000/3001 已释放
- **文件检查**: 确认关键文件已删除

### 手动验证命令
```bash
# 检查服务状态
systemctl status manager

# 检查进程
ps aux | grep -i manager

# 检查端口占用
netstat -tlnp | grep -E ":3000|:3001"

# 检查文件残留
ls -la /root/manager
ls -la /var/log/manager
```

## 📝 卸载报告

完全卸载会生成详细的卸载报告，包含：
- 卸载时间和操作用户
- 系统信息
- 已删除的组件列表
- 备份文件位置
- 注意事项和建议

报告位置：`/tmp/manager_uninstall_report_YYYYMMDD_HHMMSS.txt`

## 🚨 注意事项

### 卸载前准备
1. **备份重要数据**: 导出进程配置和重要日志
2. **停止相关服务**: 确保没有重要进程在运行
3. **通知用户**: 如果是生产环境，提前通知相关人员
4. **检查依赖**: 确认其他应用不依赖 Node.js 等组件

### 卸载后检查
1. **重启系统**: 建议重启以确保所有更改生效
2. **检查残留**: 手动检查是否有文件残留
3. **验证功能**: 确认其他系统功能正常
4. **清理缓存**: 清理可能的系统缓存

## 🔄 重新安装

### 完全卸载后重新安装
```bash
# 1. 重新下载项目
git clone <repo-url> /root/manager
cd /root/manager

# 2. 运行部署脚本
sudo ./deploy-debian.sh

# 3. 配置多服务器功能
sudo ./multi-server-setup.sh
```

### 快速卸载后重新安装
```bash
# 1. 重新下载项目
git clone <repo-url> /root/manager
cd /root/manager

# 2. 安装依赖和构建
npm install
npm run build

# 3. 启动服务
sudo ./deploy-debian.sh
```

## 🐛 故障排除

### 常见问题

1. **权限不足**
   ```bash
   # 解决方案：使用 sudo
   sudo ./uninstall-debian.sh
   ```

2. **服务无法停止**
   ```bash
   # 强制停止
   sudo systemctl kill manager
   sudo pkill -f manager
   ```

3. **文件删除失败**
   ```bash
   # 检查文件权限
   ls -la /root/manager
   # 强制删除
   sudo rm -rf /root/manager
   ```

4. **端口仍被占用**
   ```bash
   # 查找占用进程
   sudo lsof -i :3000
   # 强制结束进程
   sudo kill -9 <PID>
   ```

### 紧急恢复

如果卸载过程中出现问题：

1. **停止卸载脚本**: `Ctrl+C`
2. **检查系统状态**: 运行验证命令
3. **手动清理**: 根据需要手动删除残留文件
4. **重新安装**: 如果需要，重新运行安装脚本

## 📞 支持

如果在卸载过程中遇到问题：

1. 查看卸载报告文件
2. 检查系统日志：`journalctl -xe`
3. 运行手动验证命令
4. 参考故障排除部分

---

通过这两个卸载脚本，用户可以根据自己的需求选择合适的卸载方式，确保系统的干净和安全。
